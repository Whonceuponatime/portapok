{% extends "base.html" %}

{% block title %}{{ table_name }} - Heads Up Table{% endblock %}

{% set page = 'heads_up' %}

{% block extra_styles %}
/* Heads Up Table Styles */
.heads-up-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.table-header {
    text-align: center;
    margin-bottom: 30px;
}

.table-title {
    font-size: 2.5em;
    font-weight: bold;
    background: linear-gradient(45deg, #00d4ff, #9c27b0);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 10px;
}

.table-subtitle {
    color: var(--text-secondary);
    font-size: 1.1em;
}

/* Card Lists */
.card-lists-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.card-list {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 20px;
}

.card-list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color);
}

.card-list-title {
    font-size: 1.2em;
    font-weight: bold;
    color: var(--text-primary);
}

.card-list-status {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8em;
    font-weight: 600;
    text-transform: uppercase;
}

.card-list-status.active {
    background: var(--success-color);
    color: white;
}

.card-list-status.inactive {
    background: var(--warning-color);
    color: white;
}

.card-list-status.testing {
    background: var(--accent-color);
    color: white;
}

.card-items {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.card-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    background: var(--bg-secondary);
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.card-item.face-up {
    background: white;
    border-color: var(--success-color);
}

.card-item.face-down {
    background: var(--bg-secondary);
    border-color: var(--border-color);
}

.card-item.folded {
    background: #666;
    border-color: #666;
    opacity: 0.5;
}

.card-label {
    font-weight: 600;
    color: var(--text-primary);
}

.card-uid {
    font-family: 'Courier New', monospace;
    font-size: 0.8em;
    color: var(--text-secondary);
}

.card-status {
    font-size: 0.8em;
    font-weight: 500;
}

.card-status.face-up {
    color: var(--success-color);
}

.card-status.face-down {
    color: var(--warning-color);
}

.card-status.folded {
    color: #999;
}

/* Reader Selection */
.reader-selection {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.reader-selection h3 {
    margin: 0 0 15px 0;
    color: var(--text-primary);
}

.reader-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
}

.reader-btn {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px 16px;
    color: var(--text-primary);
    text-align: center;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
}

.reader-btn:hover {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

.reader-btn.active {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

/* Control Panel */
.control-panel {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 20px;
    margin-top: 20px;
    width: 100%;
    max-width: 600px;
}

.control-header {
    text-align: center;
    margin-bottom: 20px;
}

.control-title {
    font-size: 1.3em;
    font-weight: bold;
    margin-bottom: 5px;
}

.control-subtitle {
    color: var(--text-secondary);
    font-size: 0.9em;
}

.control-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.control-btn {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px 16px;
    color: var(--text-primary);
    text-decoration: none;
    text-align: center;
    font-weight: 500;
    transition: all 0.3s ease;
    cursor: pointer;
}

.control-btn:hover {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

.control-btn.primary {
    background: var(--accent-color);
    color: white;
    border-color: var(--accent-color);
}

.control-btn.primary:hover {
    background: var(--accent-hover);
}

/* Status Display */
.status-display {
    background: var(--bg-secondary);
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
}

.status-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.status-row:last-child {
    margin-bottom: 0;
}

.status-label {
    font-weight: 500;
    color: var(--text-secondary);
}

.status-value {
    font-weight: 600;
    color: var(--text-primary);
}

.status-value.active {
    color: var(--success-color);
}

.status-value.inactive {
    color: var(--warning-color);
}

/* Responsive Design */
@media (max-width: 768px) {
    .heads-up-container {
        padding: 10px;
    }
    
    .poker-table {
        width: 90vw;
        height: 60vw;
        max-width: 500px;
        max-height: 350px;
    }
    
    .player-position {
        width: 60px;
        height: 45px;
    }
    
    .player-name {
        font-size: 0.7em;
    }
    
    .player-cards {
        font-size: 0.6em;
    }
    
    .community-card {
        width: 40px;
        height: 55px;
        font-size: 0.7em;
    }
    
    .control-buttons {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 480px) {
    .table-title {
        font-size: 2em;
    }
    
    .poker-table {
        width: 95vw;
        height: 65vw;
    }
    
    .player-position {
        width: 50px;
        height: 40px;
    }
    
    .community-card {
        width: 35px;
        height: 50px;
        font-size: 0.6em;
    }
}
{% endblock %}

{% block content %}
<div class="heads-up-container">
    <div class="table-header">
        <h1 class="table-title">Heads Up Poker</h1>
        <p class="table-subtitle">Single Reader Testing Mode</p>
    </div>
    
    <!-- Reader Selection -->
    <div class="reader-selection">
        <h3>🎯 Select Reader Position</h3>
        <div class="reader-buttons">
            <button class="reader-btn" onclick="selectPosition('main', 'Main Player')">Main Player</button>
            <button class="reader-btn" onclick="selectPosition('p1', 'Player 1')">Player 1</button>
            <button class="reader-btn" onclick="selectPosition('p2', 'Player 2')">Player 2</button>
            <button class="reader-btn" onclick="selectPosition('p11', 'Community Cards')">Community Cards</button>
            <button class="reader-btn" onclick="selectPosition('p12', 'Dealer')">Dealer</button>
        </div>
    </div>
    
    <!-- Card Lists -->
    <div class="card-lists-container">
        <!-- Main Player Cards -->
        <div class="card-list">
            <div class="card-list-header">
                <div class="card-list-title">Main Player</div>
                <div class="card-list-status inactive" id="main-status">Inactive</div>
            </div>
            <div class="card-items" id="main-cards">
                <div class="card-item face-down">
                    <span class="card-label">No cards detected</span>
                    <span class="card-uid">-</span>
                </div>
            </div>
        </div>
        
        <!-- Player 1 Cards -->
        <div class="card-list">
            <div class="card-list-header">
                <div class="card-list-title">Player 1</div>
                <div class="card-list-status inactive" id="p1-status">Inactive</div>
            </div>
            <div class="card-items" id="p1-cards">
                <div class="card-item face-down">
                    <span class="card-label">No cards detected</span>
                    <span class="card-uid">-</span>
                </div>
            </div>
        </div>
        
        <!-- Player 2 Cards -->
        <div class="card-list">
            <div class="card-list-header">
                <div class="card-list-title">Player 2</div>
                <div class="card-list-status inactive" id="p2-status">Inactive</div>
            </div>
            <div class="card-items" id="p2-cards">
                <div class="card-item face-down">
                    <span class="card-label">No cards detected</span>
                    <span class="card-uid">-</span>
                </div>
            </div>
        </div>
        
        <!-- Community Cards -->
        <div class="card-list">
            <div class="card-list-header">
                <div class="card-list-title">Community Cards</div>
                <div class="card-list-status inactive" id="p11-status">Inactive</div>
            </div>
            <div class="card-items" id="p11-cards">
                <div class="card-item face-down">
                    <span class="card-label">Flop 1</span>
                    <span class="card-uid">-</span>
                </div>
                <div class="card-item face-down">
                    <span class="card-label">Flop 2</span>
                    <span class="card-uid">-</span>
                </div>
                <div class="card-item face-down">
                    <span class="card-label">Flop 3</span>
                    <span class="card-uid">-</span>
                </div>
                <div class="card-item face-down">
                    <span class="card-label">Turn</span>
                    <span class="card-uid">-</span>
                </div>
                <div class="card-item face-down">
                    <span class="card-label">River</span>
                    <span class="card-uid">-</span>
                </div>
            </div>
        </div>
        
        <!-- Dealer Position -->
        <div class="card-list">
            <div class="card-list-header">
                <div class="card-list-title">Dealer</div>
                <div class="card-list-status inactive" id="p12-status">Inactive</div>
            </div>
            <div class="card-items" id="p12-cards">
                <div class="card-item face-down">
                    <span class="card-label">No cards detected</span>
                    <span class="card-uid">-</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="control-panel">
        <div class="control-header">
            <h3 class="control-title">Reader Control</h3>
            <p class="control-subtitle">Select a position to test with your single reader</p>
        </div>
        
        <div class="control-buttons">
            <button class="control-btn primary" onclick="goToCalibration()">
                🎯 Run Calibration
            </button>
            <button class="control-btn" onclick="resetTable()">
                🔄 Reset Table
            </button>
            <button class="control-btn" onclick="viewCards()">
                🃏 View Cards
            </button>
            <button class="control-btn" onclick="viewConfig()">
                ⚙️ Configuration
            </button>
        </div>
        
        <div class="status-display">
            <div class="status-row">
                <span class="status-label">Current Reader:</span>
                <span class="status-value" id="current-reader-name">None Selected</span>
            </div>
            <div class="status-row">
                <span class="status-label">Reader Status:</span>
                <span class="status-value inactive" id="reader-status-text">Inactive</span>
            </div>
            <div class="status-row">
                <span class="status-label">Cards Detected:</span>
                <span class="status-value" id="cards-detected">0</span>
            </div>
            <div class="status-row">
                <span class="status-label">Last Update:</span>
                <span class="status-value" id="last-update">Never</span>
            </div>
        </div>
    </div>
</div>

<script>
let currentPosition = null;
let currentReader = null;

// Select a position for testing
function selectPosition(readerName, displayName) {
    // Remove active class from all reader buttons
    document.querySelectorAll('.reader-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Add active class to selected button
    event.target.classList.add('active');
    
    currentPosition = readerName;
    currentReader = displayName;
    
    // Update UI
    document.getElementById('current-reader-name').textContent = displayName;
    document.getElementById('reader-status-text').textContent = 'Inactive';
    document.getElementById('reader-status-text').className = 'status-value inactive';
    
    // Start monitoring this reader
    startMonitoring(readerName);
}

// Start monitoring the selected reader
function startMonitoring(readerName) {
    const interval = setInterval(() => {
        if (currentPosition !== readerName) {
            clearInterval(interval);
            return;
        }
        
        fetch(`/api/reader/${readerName}/status`)
            .then(response => response.json())
            .then(data => {
                updateReaderStatus(data);
            })
            .catch(error => {
                console.error('Error monitoring reader:', error);
            });
    }, 1000);
}

// Update reader status display
function updateReaderStatus(data) {
    const isActive = data.is_active;
    const cardCount = data.hand_size || 0;
    const cards = data.hand_cards || [];
    
    // Update status indicator
    const statusElement = document.getElementById(`${data.reader}-status`);
    const statusText = document.getElementById('reader-status-text');
    
    if (isActive) {
        statusElement.textContent = 'Active';
        statusElement.className = 'card-list-status active';
        statusText.textContent = 'Active';
        statusText.className = 'status-value active';
    } else {
        statusElement.textContent = 'Inactive';
        statusElement.className = 'card-list-status inactive';
        statusText.textContent = 'Inactive';
        statusText.className = 'status-value inactive';
    }
    
    // Update card count
    document.getElementById('cards-detected').textContent = cardCount;
    
    // Update card display
    updateCardDisplay(data.reader, cards);
    
    // Update last update time
    document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
}

// Update card display for a specific reader
function updateCardDisplay(readerName, cards) {
    const cardContainer = document.getElementById(`${readerName}-cards`);
    if (!cardContainer) return;
    
    // Clear existing cards
    cardContainer.innerHTML = '';
    
    if (cards.length === 0) {
        // Show "no cards" message
        const noCardItem = document.createElement('div');
        noCardItem.className = 'card-item face-down';
        noCardItem.innerHTML = `
            <span class="card-label">No cards detected</span>
            <span class="card-uid">-</span>
        `;
        cardContainer.appendChild(noCardItem);
    } else {
        // Show detected cards
        cards.forEach((card, index) => {
            const cardItem = document.createElement('div');
            cardItem.className = 'card-item face-up';
            cardItem.innerHTML = `
                <span class="card-label">${card.label || 'Unknown Card'}</span>
                <span class="card-uid">${card.uid || '-'}</span>
            `;
            cardContainer.appendChild(cardItem);
        });
    }
}

// Navigation functions
function goToCalibration() {
    window.location.href = '/calibration';
}

function resetTable() {
    if (confirm('Reset the table? This will clear all card data.')) {
        // Reset all reader buttons
        document.querySelectorAll('.reader-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Reset all card lists
        ['main', 'p1', 'p2', 'p11', 'p12'].forEach(reader => {
            const statusElement = document.getElementById(`${reader}-status`);
            if (statusElement) {
                statusElement.textContent = 'Inactive';
                statusElement.className = 'card-list-status inactive';
            }
            
            // Reset card display
            updateCardDisplay(reader, []);
        });
        
        // Reset status
        currentPosition = null;
        currentReader = null;
        document.getElementById('current-reader-name').textContent = 'None Selected';
        document.getElementById('reader-status-text').textContent = 'Inactive';
        document.getElementById('reader-status-text').className = 'status-value inactive';
        document.getElementById('cards-detected').textContent = '0';
        document.getElementById('last-update').textContent = 'Never';
    }
}

function viewCards() {
    window.location.href = '/cards';
}

function viewConfig() {
    window.location.href = '/config';
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('Heads Up Table initialized');
});
</script>
{% endblock %}
