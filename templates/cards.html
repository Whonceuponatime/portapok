{% extends "base.html" %}

{% block title %}Card Library - {{ table_name }}{% endblock %}

{% block extra_styles %}
.cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
    margin: 30px 0;
}
.card-item {
    background: rgba(30, 30, 50, 0.9);
    border-radius: 15px;
    padding: 20px;
    border: 1px solid rgba(156, 39, 176, 0.3);
    transition: all 0.3s ease;
    position: relative;
}
.card-item:hover {
    transform: translateY(-5px);
    border-color: rgba(156, 39, 176, 0.6);
    box-shadow: 0 10px 30px rgba(156, 39, 176, 0.3);
}
.card-display {
    font-size: 3em;
    text-align: center;
    margin-bottom: 15px;
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(30, 30, 50, 0.6));
    border-radius: 10px;
    padding: 20px;
    border: 1px solid rgba(0, 212, 255, 0.2);
}
.card-uid {
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
    color: #00d4ff;
    margin-bottom: 10px;
    word-break: break-all;
}
.card-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}
.btn-small {
    padding: 8px 12px;
    font-size: 0.8em;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: bold;
}
.btn-edit {
    background: linear-gradient(45deg, #00d4ff, #0084ff);
    color: white;
    flex: 1;
}
.btn-edit:hover {
    background: linear-gradient(45deg, #0084ff, #0066cc);
    transform: translateY(-1px);
}
.btn-delete {
    background: linear-gradient(45deg, #ff4757, #ff3838);
    color: white;
    flex: 1;
}
.btn-delete:hover {
    background: linear-gradient(45deg, #ff3838, #ff2f2f);
    transform: translateY(-1px);
}
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #8892b0;
}
.empty-icon {
    font-size: 4em;
    margin-bottom: 20px;
    opacity: 0.5;
}
.search-bar {
    background: rgba(30, 30, 50, 0.8);
    padding: 20px;
    border-radius: 15px;
    margin-bottom: 30px;
    border: 1px solid rgba(0, 212, 255, 0.2);
}
.search-input {
    width: 100%;
    padding: 12px 15px;
    background: rgba(50, 50, 70, 0.8);
    border: 1px solid rgba(100, 100, 120, 0.3);
    border-radius: 8px;
    color: #e0e6ed;
    font-size: 1em;
}
.search-input:focus {
    outline: none;
    border-color: #00d4ff;
    box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
}
.filter-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}
.filter-tab {
    padding: 8px 16px;
    background: rgba(50, 50, 70, 0.8);
    border: 1px solid rgba(100, 100, 120, 0.3);
    border-radius: 20px;
    color: #b8c5d1;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9em;
}
.filter-tab.active {
    background: linear-gradient(45deg, #00d4ff, #0084ff);
    color: white;
    border-color: transparent;
}
.stats-summary {
    display: flex;
    justify-content: space-around;
    background: rgba(30, 30, 50, 0.8);
    padding: 20px;
    border-radius: 15px;
    margin-bottom: 30px;
    border: 1px solid rgba(0, 212, 255, 0.2);
}
.summary-item {
    text-align: center;
}
.summary-number {
    font-size: 2em;
    font-weight: bold;
    background: linear-gradient(45deg, #00d4ff, #9c27b0);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}
.summary-label {
    color: #b8c5d1;
    font-size: 0.9em;
}
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1 class="page-title">Card Library</h1>
        <p class="page-subtitle">Manage and organize your RFID cards</p>
    </div>
    
    <div class="stats-summary">
        <div class="summary-item">
            <div class="summary-number" id="totalCards">0</div>
            <div class="summary-label">Total Cards</div>
        </div>
        <div class="summary-item">
            <div class="summary-number" id="activeCards">0</div>
            <div class="summary-label">Currently Active</div>
        </div>
        <div class="summary-item">
            <div class="summary-number" id="uniqueSuits">0</div>
            <div class="summary-label">Unique Suits</div>
        </div>
        <div class="summary-item">
            <div class="summary-number" id="lastAdded">Never</div>
            <div class="summary-label">Last Added</div>
        </div>
    </div>
    
    <div class="search-bar">
        <input type="text" class="search-input" id="searchInput" placeholder="üîç Search cards by label or UID...">
        <div class="filter-tabs">
            <div class="filter-tab active" onclick="filterCards('all')">All Cards</div>
            <div class="filter-tab" onclick="filterCards('spades')">‚ô† Spades</div>
            <div class="filter-tab" onclick="filterCards('hearts')">‚ô• Hearts</div>
            <div class="filter-tab" onclick="filterCards('diamonds')">‚ô¶ Diamonds</div>
            <div class="filter-tab" onclick="filterCards('clubs')">‚ô£ Clubs</div>
        </div>
    </div>
    
    <div id="cardsContainer">
        <div class="cards-grid" id="cardsGrid">
            <!-- Cards will be populated here -->
        </div>
        
        <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-icon">üÉè</div>
            <h3>No cards found</h3>
            <p>Start by mapping cards in the configuration page</p>
        </div>
    </div>
</div>

<!-- Edit Card Modal -->
<div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
    <div style="background: rgba(30, 30, 50, 0.95); padding: 30px; border-radius: 15px; border: 1px solid rgba(0, 212, 255, 0.3); max-width: 400px; width: 90%;">
        <h3 style="margin-bottom: 20px; color: #00d4ff;">Edit Card</h3>
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; color: #b8c5d1;">UID:</label>
            <input type="text" id="editUid" readonly style="width: 100%; padding: 10px; background: rgba(50, 50, 70, 0.5); border: 1px solid rgba(100, 100, 120, 0.3); border-radius: 6px; color: #8892b0;">
        </div>
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; color: #b8c5d1;">Label:</label>
            <input type="text" id="editLabel" style="width: 100%; padding: 10px; background: rgba(50, 50, 70, 0.8); border: 1px solid rgba(100, 100, 120, 0.3); border-radius: 6px; color: #e0e6ed;">
        </div>
        <div style="display: flex; gap: 10px;">
            <button onclick="saveEdit()" style="flex: 1; padding: 10px; background: linear-gradient(45deg, #00ff88, #00cc6a); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">Save</button>
            <button onclick="closeEdit()" style="flex: 1; padding: 10px; background: rgba(100, 100, 120, 0.8); color: white; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let allCards = {};
    let currentFilter = 'all';
    
    // Load and display cards
    async function loadCards() {
        try {
            const [cardsRes, stateRes] = await Promise.all([
                fetch('/api/cards'),
                fetch('/api/state')
            ]);
            
            allCards = await cardsRes.json();
            const state = await stateRes.json();
            
            updateStats(state);
            displayCards();
            
        } catch (error) {
            console.error('Failed to load cards:', error);
        }
    }
    
    function updateStats(state) {
        const totalCards = Object.keys(allCards).length;
        let activeCount = 0;
        Object.values(state).forEach(reader => {
            if (reader.uid && reader.label) activeCount++;
        });
        
        const suits = new Set();
        Object.values(allCards).forEach(label => {
            if (label.includes('‚ô†')) suits.add('spades');
            if (label.includes('‚ô•')) suits.add('hearts');
            if (label.includes('‚ô¶')) suits.add('diamonds');
            if (label.includes('‚ô£')) suits.add('clubs');
        });
        
        document.getElementById('totalCards').textContent = totalCards;
        document.getElementById('activeCards').textContent = activeCount;
        document.getElementById('uniqueSuits').textContent = suits.size;
    }
    
    function displayCards() {
        const grid = document.getElementById('cardsGrid');
        const emptyState = document.getElementById('emptyState');
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        
        // Filter cards
        let filteredCards = Object.entries(allCards);
        
        if (searchTerm) {
            filteredCards = filteredCards.filter(([uid, label]) => 
                uid.toLowerCase().includes(searchTerm) || 
                label.toLowerCase().includes(searchTerm)
            );
        }
        
        if (currentFilter !== 'all') {
            const suitSymbols = {
                'spades': '‚ô†',
                'hearts': '‚ô•',
                'diamonds': '‚ô¶',
                'clubs': '‚ô£'
            };
            filteredCards = filteredCards.filter(([uid, label]) => 
                label.includes(suitSymbols[currentFilter])
            );
        }
        
        if (filteredCards.length === 0) {
            grid.style.display = 'none';
            emptyState.style.display = 'block';
            return;
        }
        
        grid.style.display = 'grid';
        emptyState.style.display = 'none';
        
        grid.innerHTML = filteredCards.map(([uid, label]) => `
            <div class="card-item">
                <div class="card-display">${label}</div>
                <div class="card-uid">UID: ${uid}</div>
                <div class="card-actions">
                    <button class="btn-small btn-edit" onclick="editCard('${uid}', '${label}')">
                        ‚úèÔ∏è Edit
                    </button>
                    <button class="btn-small btn-delete" onclick="deleteCard('${uid}')">
                        üóëÔ∏è Delete
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    function filterCards(filter) {
        currentFilter = filter;
        
        // Update active tab
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        event.target.classList.add('active');
        
        displayCards();
    }
    
    function editCard(uid, label) {
        document.getElementById('editUid').value = uid;
        document.getElementById('editLabel').value = label;
        document.getElementById('editModal').style.display = 'flex';
    }
    
    function closeEdit() {
        document.getElementById('editModal').style.display = 'none';
    }
    
    async function saveEdit() {
        const uid = document.getElementById('editUid').value;
        const newLabel = document.getElementById('editLabel').value.trim();
        
        if (!newLabel) {
            alert('Please enter a card label');
            return;
        }
        
        try {
            const response = await fetch('/api/map', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ uid, label: newLabel })
            });
            
            if (response.ok) {
                closeEdit();
                loadCards();
            } else {
                const error = await response.json();
                alert(`Error: ${error.error}`);
            }
        } catch (error) {
            alert(`Network error: ${error.message}`);
        }
    }
    
    async function deleteCard(uid) {
        if (!confirm(`Delete card with UID ${uid}?`)) return;
        
        try {
            const response = await fetch('/api/clear', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ uid })
            });
            
            if (response.ok) {
                loadCards();
            } else {
                const error = await response.json();
                alert(`Error: ${error.error}`);
            }
        } catch (error) {
            alert(`Network error: ${error.message}`);
        }
    }
    
    // Search functionality
    document.getElementById('searchInput').addEventListener('input', displayCards);
    
    // Close modal when clicking outside
    document.getElementById('editModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeEdit();
        }
    });
    
    // Load cards on page load
    loadCards();
    setInterval(loadCards, 5000); // Refresh every 5 seconds
</script>
{% endblock %}
