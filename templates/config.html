{% extends "base.html" %}

{% block title %}Configuration - {{ table_name }}{% endblock %}

{% block extra_styles %}
.config-section {
    background: rgba(30, 30, 50, 0.8);
    padding: 25px;
    border-radius: 15px;
    margin-bottom: 30px;
    border: 1px solid rgba(0, 212, 255, 0.2);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}
.config-section h3 {
    color: #00d4ff;
    margin-bottom: 20px;
    font-size: 1.5em;
    text-shadow: 0 2px 10px rgba(0, 212, 255, 0.3);
}
.form-group {
    margin-bottom: 15px;
}
.form-row {
    display: flex;
    gap: 15px;
    align-items: end;
}

/* Responsive Design for Config */
@media (max-width: 768px) {
    .config-section {
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .form-row {
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
    }
    
    .form-group input, .form-group select {
        padding: 12px;
        font-size: 1em;
        width: 100%;
    }
    
    .btn {
        padding: 12px 20px;
        font-size: 1em;
        width: 100%;
        margin-bottom: 10px;
    }
    
    .btn-group {
        flex-direction: column;
        gap: 10px;
    }
    
    .card-info-grid {
        grid-template-columns: 1fr !important;
        gap: 10px !important;
    }
    
    .card-header {
        flex-direction: column;
        gap: 10px;
        text-align: center;
    }
    
    .card-title {
        font-size: 1.1em;
    }
    
    .card-status {
        font-size: 0.8em;
        padding: 4px 8px;
    }
}

@media (max-width: 480px) {
    .config-section {
        padding: 12px;
        margin-bottom: 15px;
    }
    
    .form-group input, .form-group select {
        padding: 10px;
        font-size: 0.9em;
    }
    
    .btn {
        padding: 10px 16px;
        font-size: 0.9em;
    }
    
    .card-title {
        font-size: 1em;
    }
    
    .card-status {
        font-size: 0.7em;
    }
}
label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #b8c5d1;
}
input, select, button {
    padding: 10px 15px;
    border: none;
    border-radius: 8px;
    font-size: 1em;
    transition: all 0.3s ease;
}
input, select {
    background: rgba(50, 50, 70, 0.8);
    color: #e0e6ed;
    border: 1px solid rgba(100, 100, 120, 0.3);
    flex: 1;
}
input:focus, select:focus {
    outline: none;
    border-color: #00d4ff;
    box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
}
input::placeholder {
    color: rgba(184, 197, 209, 0.6);
}
.uid-input {
    background: rgba(20, 20, 35, 0.9) !important;
    border: 1px solid rgba(0, 212, 255, 0.3) !important;
    color: #00d4ff !important;
    font-family: 'Courier New', monospace;
    font-weight: bold;
}
button {
    background: linear-gradient(45deg, #00ff88, #00cc6a);
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 120px;
    font-weight: bold;
    box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
}
button:hover {
    background: linear-gradient(45deg, #00cc6a, #00aa55);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 255, 136, 0.4);
}
.btn-danger {
    background: linear-gradient(45deg, #ff4757, #ff3838);
    box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3);
}
.btn-danger:hover {
    background: linear-gradient(45deg, #ff3838, #ff2f2f);
    box-shadow: 0 6px 20px rgba(255, 71, 87, 0.4);
}
.btn-pn532 {
    background: linear-gradient(45deg, #9c27b0, #7b1fa2);
    box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);
}
.btn-pn532:hover {
    background: linear-gradient(45deg, #7b1fa2, #6a1b9a);
    box-shadow: 0 6px 20px rgba(156, 39, 176, 0.4);
}
.deck-selector {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
    gap: 8px;
    max-height: 200px;
    overflow-y: auto;
    padding: 15px;
    background: rgba(20, 20, 35, 0.8);
    border-radius: 10px;
    margin-top: 10px;
    border: 1px solid rgba(100, 100, 120, 0.2);
}
.deck-card {
    padding: 8px;
    background: rgba(50, 50, 70, 0.9);
    color: #e0e6ed;
    text-align: center;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: bold;
    border: 1px solid rgba(100, 100, 120, 0.3);
}
.deck-card:hover {
    background: linear-gradient(45deg, #00ff88, #00cc6a);
    color: white;
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
}
.deck-card.used {
    background: linear-gradient(45deg, #ff4757, #ff3838);
    color: white;
    cursor: not-allowed;
    box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3);
}
.results {
    background: rgba(20, 20, 35, 0.9);
    padding: 15px;
    border-radius: 10px;
    margin-top: 15px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
    max-height: 300px;
    overflow-y: auto;
    display: none;
    border: 1px solid rgba(0, 212, 255, 0.2);
    color: #00ff88;
}
.results h4 {
    color: #00d4ff;
    margin-bottom: 10px;
}
.auto-capture-indicator {
    display: inline-block;
    padding: 5px 10px;
    background: linear-gradient(45deg, #00ff88, #00cc6a);
    border-radius: 15px;
    font-size: 0.8em;
    font-weight: bold;
    margin-left: 10px;
    animation: pulse 2s infinite;
}
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}
.reader-status {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px;
    background: rgba(20, 20, 35, 0.6);
    border-radius: 10px;
    margin-bottom: 20px;
}
.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #ff4757;
}
.status-indicator.online {
    background: #00ff88;
    box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
}
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1 class="page-title">System Configuration</h1>
        <p class="page-subtitle">Configure your RFID poker system and manage cards</p>
    </div>
    
    <!-- PN532 Status -->
    <div class="config-section">
        <h3>üîß PN532 Reader Status</h3>
        <div class="reader-status">
            <div class="status-indicator" id="pn532Status"></div>
            <div style="flex: 1;">
                <div style="font-weight: bold;">PN532 NFC Module</div>
                <div style="color: #8892b0; font-size: 0.9em;" id="pn532Info">Checking connection...</div>
            </div>
        </div>
        
        <!-- Current Hand Display -->
        <div id="handDataSection" style="display: none; margin-top: 20px; padding: 20px; background: rgba(20, 20, 35, 0.6); border-radius: 10px; border: 1px solid rgba(0, 212, 255, 0.2);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="color: #00d4ff; margin: 0;">üÉè Current Player Hand</h4>
                <button onclick="refreshHandData()" style="padding: 5px 10px; font-size: 0.8em; background: linear-gradient(45deg, #00d4ff, #0084ff);">
                    üîÑ Refresh
                </button>
            </div>
            
            <div id="handStatus" style="margin-bottom: 15px; padding: 10px; background: rgba(0, 0, 0, 0.3); border-radius: 8px;">
                <div style="color: #ff9800; font-weight: bold;" id="stabilityStatus">Checking stability...</div>
                <div style="color: #8892b0; font-size: 0.9em;" id="stabilityTimer">-</div>
            </div>
        </div>
        
        <!-- Current Card Data Display -->
        <div id="cardDataSection" style="display: none; margin-top: 20px; padding: 20px; background: rgba(20, 20, 35, 0.6); border-radius: 10px; border: 1px solid rgba(0, 212, 255, 0.2);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="color: #00d4ff; margin: 0;">üìã Individual Card Data</h4>
                <button onclick="refreshCardData()" style="padding: 5px 10px; font-size: 0.8em; background: linear-gradient(45deg, #00d4ff, #0084ff);">
                    üîÑ Refresh
                </button>
            </div>
            
            <div class="card-info-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <strong style="color: #b8c5d1;">UID:</strong>
                    <div id="currentUID" style="font-family: 'Courier New', monospace; color: #00d4ff; font-weight: bold;">-</div>
                </div>
                <div>
                    <strong style="color: #b8c5d1;">Mapped Label:</strong>
                    <div id="currentMappedLabel" style="color: #00ff88; font-weight: bold;">-</div>
                </div>
                <div>
                    <strong style="color: #b8c5d1;">On-Card Label:</strong>
                    <div id="currentCardLabel" style="color: #ff9800; font-weight: bold;">-</div>
                </div>
                <div>
                    <strong style="color: #b8c5d1;">Last Updated:</strong>
                    <div id="lastUpdated" style="color: #8892b0; font-size: 0.9em;">-</div>
                </div>
            </div>
            
            <div id="cardPagesData" style="background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.85em; max-height: 300px; overflow-y: auto;">
                <!-- Card pages data will be displayed here -->
            </div>
        </div>
    </div>
    
    <!-- Card Management -->
    <div class="config-section">
        <h3>üÉè Card Management
            <span class="auto-capture-indicator" id="autoCaptureIndicator" style="display: none;">
                AUTO-CAPTURE READY
            </span>
        </h3>
        
        <div class="form-group">
            <div class="form-row">
                <div style="flex: 1;">
                    <label for="mapUid">Card UID: <small>(Place card on reader for auto-capture)</small></label>
                    <input type="text" id="mapUid" class="uid-input" placeholder="e.g., 04A1B2C3D4" style="text-transform: uppercase;">
                </div>
                <div style="flex: 1;">
                    <label for="mapLabel">Card Label:</label>
                    <input type="text" id="mapLabel" placeholder="e.g., A‚ô† or custom">
                </div>
                <div>
                    <button onclick="mapCard()">Map Card</button>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>Quick Select from Deck:</label>
            <div class="deck-selector" id="deckSelector">
                <!-- Deck cards will be populated here -->
            </div>
        </div>

        <div class="form-group">
            <div class="form-row">
                <div style="flex: 1;">
                    <label for="clearUid">Clear Card UID:</label>
                    <input type="text" id="clearUid" class="uid-input" placeholder="UID to remove" style="text-transform: uppercase;">
                </div>
                <div>
                    <button class="btn-danger" onclick="clearCard()">Clear Mapping</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NTAG213 Operations -->
    <div class="config-section">
        <h3>üè∑Ô∏è NTAG213 Operations</h3>
        
        <div class="form-group">
            <div class="form-row">
                <div style="flex: 1;">
                    <label for="ntagPage">Page (4-39):</label>
                    <input type="number" id="ntagPage" min="4" max="39" value="4" placeholder="4">
                </div>
                <div>
                    <button class="btn-pn532" onclick="readNtagPage()">Read Page</button>
                </div>
            </div>
        </div>

        <div class="form-group">
            <div class="form-row">
                <div style="flex: 2;">
                    <label for="ntagData">Data (8 hex chars = 4 bytes):</label>
                    <input type="text" id="ntagData" placeholder="41434521" maxlength="8" style="text-transform: uppercase;">
                </div>
                <div>
                    <button class="btn-pn532" onclick="writeNtagPage()">Write Page</button>
                </div>
            </div>
        </div>

        <div class="form-group">
            <div class="form-row">
                <div style="flex: 2;">
                    <label for="cardLabelWrite">Write Card Label to NTAG:</label>
                    <input type="text" id="cardLabelWrite" placeholder="A‚ô†" maxlength="4">
                </div>
                <div>
                    <button onclick="writeCardLabel()" style="background: linear-gradient(45deg, #FF9800, #F57C00);">Write Label</button>
                </div>
                <div>
                    <button onclick="readCardLabel()" style="background: linear-gradient(45deg, #2196F3, #1976D2);">Read Label</button>
                </div>
            </div>
        </div>

        <div id="ntagResults" class="results">
            <!-- NTAG operation results will appear here -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let usedCards = new Set();
    let autoCapture = true;

    // Create deck selector
    function createDeckSelector() {
        const deckSelector = document.getElementById('deckSelector');
        const suits = ['‚ô†', '‚ô•', '‚ô¶', '‚ô£'];
        const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
        
        suits.forEach(suit => {
            values.forEach(value => {
                const card = document.createElement('div');
                card.className = 'deck-card';
                card.textContent = value + suit;
                card.onclick = () => selectDeckCard(value + suit);
                deckSelector.appendChild(card);
            });
        });
    }

    function selectDeckCard(cardLabel) {
        document.getElementById('mapLabel').value = cardLabel;
    }

    // Auto-capture UID functionality
    async function checkForNewUID() {
        if (!autoCapture) return;
        
        try {
            const response = await fetch('/api/last_uid');
            const data = await response.json();
            
            if (data.uid && data.uid !== document.getElementById('mapUid').value) {
                document.getElementById('mapUid').value = data.uid;
                document.getElementById('autoCaptureIndicator').style.display = 'inline-block';
                
                // Flash the UID input to indicate auto-capture
                const uidInput = document.getElementById('mapUid');
                uidInput.style.background = 'linear-gradient(45deg, #00ff88, #00cc6a)';
                setTimeout(() => {
                    uidInput.style.background = 'rgba(20, 20, 35, 0.9)';
                }, 1000);
            }
        } catch (error) {
            console.error('Auto-capture error:', error);
        }
    }

    // Update card usage
    async function updateCardUsage() {
        try {
            const response = await fetch('/api/cards');
            const cards = await response.json();
            usedCards = new Set(Object.values(cards));
            updateDeckSelector();
        } catch (error) {
            console.error('Failed to update cards:', error);
        }
    }

    function updateDeckSelector() {
        document.querySelectorAll('.deck-card').forEach(card => {
            if (usedCards.has(card.textContent)) {
                card.classList.add('used');
            } else {
                card.classList.remove('used');
            }
        });
    }

    // Check PN532 status and load hand/card data
    async function checkPN532Status() {
        try {
            const [stateRes, handRes] = await Promise.all([
                fetch('/api/state'),
                fetch('/api/current_hand')
            ]);
            
            const state = await stateRes.json();
            const hand = await handRes.json();
            
            const statusIndicator = document.getElementById('pn532Status');
            const statusInfo = document.getElementById('pn532Info');
            
            const hasActiveReader = Object.values(state).some(reader => reader.last_seen);
            
            if (hasActiveReader) {
                statusIndicator.classList.add('online');
                statusInfo.textContent = 'Connected and detecting cards';
                
                // Load hand data
                loadCurrentHandData(hand);
                
                // Load individual card data if available
                loadCurrentCardData();
            } else {
                statusIndicator.classList.remove('online');
                statusInfo.textContent = 'Connected but no cards detected';
                // Hide sections
                document.getElementById('handDataSection').style.display = 'none';
                document.getElementById('cardDataSection').style.display = 'none';
            }
        } catch (error) {
            const statusIndicator = document.getElementById('pn532Status');
            const statusInfo = document.getElementById('pn532Info');
            statusIndicator.classList.remove('online');
            statusInfo.textContent = 'Connection error';
            document.getElementById('handDataSection').style.display = 'none';
            document.getElementById('cardDataSection').style.display = 'none';
        }
    }

    // Load current hand data
    function loadCurrentHandData(hand) {
        const handSection = document.getElementById('handDataSection');
        const stabilityStatus = document.getElementById('stabilityStatus');
        const stabilityTimer = document.getElementById('stabilityTimer');
        
        if (hand.hand_size > 0) {
            handSection.style.display = 'block';
            
            if (hand.is_stable) {
                if (hand.hand_size === 2) {
                    const labels = hand.hand_cards.map(c => c.label || 'Unknown').join(' + ');
                    stabilityStatus.textContent = `Stable Player Hand: ${labels}`;
                    stabilityStatus.style.color = '#00ff88';
                } else if (hand.hand_size === 1) {
                    const label = hand.hand_cards[0].label || 'Unknown';
                    stabilityStatus.textContent = `Single Card: ${label}`;
                    stabilityStatus.style.color = '#00d4ff';
                } else {
                    stabilityStatus.textContent = `${hand.hand_size} Cards Detected`;
                    stabilityStatus.style.color = '#ff9800';
                }
                
                const stableTime = hand.last_stable ? 
                    Math.round((Date.now() / 1000) - hand.last_stable) : 0;
                stabilityTimer.textContent = `Stable for ${stableTime} seconds`;
            } else {
                stabilityStatus.textContent = 'Cards detected, waiting for stability...';
                stabilityStatus.style.color = '#ff9800';
                stabilityTimer.textContent = 'Need 3 seconds of consistent detection';
            }
        } else if (hand.fold_start) {
            handSection.style.display = 'block';
            const foldTime = Math.round((Date.now() / 1000) - hand.fold_start);
            stabilityStatus.textContent = 'Cards removed - waiting for fold confirmation';
            stabilityStatus.style.color = '#ff4757';
            stabilityTimer.textContent = `Gone for ${foldTime}s (need 5s to fold)`;
        } else {
            handSection.style.display = 'none';
        }
    }

    // Manual refresh hand data
    async function refreshHandData() {
        const refreshBtn = event.target;
        refreshBtn.disabled = true;
        refreshBtn.textContent = '‚è≥ Reading...';
        
        try {
            const response = await fetch('/api/current_hand');
            const hand = await response.json();
            loadCurrentHandData(hand);
        } finally {
            setTimeout(() => {
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = 'üîÑ Refresh';
            }, 1000);
        }
    }

    // Load current card data
    async function loadCurrentCardData() {
        try {
            const response = await fetch('/api/current_card_data');
            
            if (response.ok) {
                const cardData = await response.json();
                displayCardData(cardData);
                document.getElementById('cardDataSection').style.display = 'block';
            } else {
                // No card detected or error
                document.getElementById('cardDataSection').style.display = 'none';
            }
        } catch (error) {
            console.error('Failed to load card data:', error);
            document.getElementById('cardDataSection').style.display = 'none';
        }
    }

    // Display card data in the UI
    function displayCardData(cardData) {
        document.getElementById('currentUID').textContent = cardData.uid || '-';
        document.getElementById('currentMappedLabel').textContent = cardData.mapped_label || 'Not mapped';
        document.getElementById('currentCardLabel').textContent = cardData.card_label || 'Empty';
        document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
        
        // Display pages data
        const pagesContainer = document.getElementById('cardPagesData');
        if (cardData.pages && Object.keys(cardData.pages).length > 0) {
            let pagesHtml = '<div style="color: #00d4ff; font-weight: bold; margin-bottom: 10px;">NTAG213 Memory Pages:</div>';
            
            Object.entries(cardData.pages).forEach(([page, info]) => {
                pagesHtml += `
                    <div style="margin-bottom: 8px;">
                        <span style="color: #9c27b0;">Page ${page}</span> 
                        <span style="color: #8892b0;">(${info.description}):</span><br>
                        <span style="color: #00ff88;">HEX: ${info.hex}</span><br>
                        <span style="color: #ff9800;">ASC: ${info.ascii}</span>
                    </div>
                `;
            });
            
            if (cardData.errors && cardData.errors.length > 0) {
                pagesHtml += '<div style="color: #ff4757; margin-top: 10px;">Errors:</div>';
                cardData.errors.forEach(error => {
                    pagesHtml += `<div style="color: #ff4757; font-size: 0.8em;">${error}</div>`;
                });
            }
            
            pagesContainer.innerHTML = pagesHtml;
        } else {
            pagesContainer.innerHTML = '<div style="color: #8892b0;">No card data available</div>';
        }
    }

    // Manual refresh function
    async function refreshCardData() {
        const refreshBtn = event.target;
        refreshBtn.disabled = true;
        refreshBtn.textContent = '‚è≥ Reading...';
        
        try {
            await loadCurrentCardData();
        } finally {
            setTimeout(() => {
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = 'üîÑ Refresh';
            }, 1000);
        }
    }

    // Map card function
    async function mapCard() {
        const uid = document.getElementById('mapUid').value.trim().toUpperCase();
        const label = document.getElementById('mapLabel').value.trim();
        
        if (!uid || !label) {
            alert('Please enter both UID and label');
            return;
        }
        
        try {
            const response = await fetch('/api/map', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ uid, label })
            });
            
            if (response.ok) {
                document.getElementById('mapUid').value = '';
                document.getElementById('mapLabel').value = '';
                document.getElementById('autoCaptureIndicator').style.display = 'none';
                updateCardUsage();
                alert(`Successfully mapped ${uid} to ${label}!`);
            } else {
                const error = await response.json();
                alert(`Error: ${error.error}`);
            }
        } catch (error) {
            alert(`Network error: ${error.message}`);
        }
    }

    // Clear card function
    async function clearCard() {
        const uid = document.getElementById('clearUid').value.trim().toUpperCase();
        
        if (!uid) {
            alert('Please enter UID to clear');
            return;
        }
        
        try {
            const response = await fetch('/api/clear', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ uid })
            });
            
            if (response.ok) {
                document.getElementById('clearUid').value = '';
                updateCardUsage();
                alert(`Successfully cleared UID ${uid}!`);
            } else {
                const error = await response.json();
                alert(`Error: ${error.error}`);
            }
        } catch (error) {
            alert(`Network error: ${error.message}`);
        }
    }

    // NTAG213 Functions
    function showNtagResults(title, data) {
        const results = document.getElementById('ntagResults');
        results.innerHTML = `<h4>${title}</h4><pre>${JSON.stringify(data, null, 2)}</pre>`;
        results.style.display = 'block';
    }

    async function readNtagPage() {
        const page = document.getElementById('ntagPage').value;
        
        if (!page) {
            alert('Please enter page number');
            return;
        }
        
        try {
            const response = await fetch(`/ntag/read?page=${page}`);
            const data = await response.json();
            
            if (response.ok) {
                showNtagResults(`Read Page ${page}`, data);
            } else {
                alert(`Error: ${data.error}`);
            }
        } catch (error) {
            alert(`Network error: ${error.message}`);
        }
    }

    async function writeNtagPage() {
        const page = parseInt(document.getElementById('ntagPage').value);
        const data = document.getElementById('ntagData').value.trim().toUpperCase();
        
        if (!page || !data) {
            alert('Please fill page and data fields');
            return;
        }
        
        if (data.length !== 8) {
            alert('Data must be exactly 8 hex characters (4 bytes)');
            return;
        }
        
        try {
            const response = await fetch('/ntag/write', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ page: page, data_hex: data })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showNtagResults(`Write Page ${page}`, result);
                document.getElementById('ntagData').value = '';
            } else {
                alert(`Error: ${result.error}`);
            }
        } catch (error) {
            alert(`Network error: ${error.message}`);
        }
    }

    async function writeCardLabel() {
        const cardLabel = document.getElementById('cardLabelWrite').value.trim();
        
        if (!cardLabel) {
            alert('Please enter card label');
            return;
        }
        
        // Convert to hex (pad to 4 bytes)
        const labelBytes = new TextEncoder().encode(cardLabel);
        const paddedBytes = new Uint8Array(4);
        paddedBytes.set(labelBytes.slice(0, 4));
        const hexData = Array.from(paddedBytes).map(b => b.toString(16).padStart(2, '0')).join('').toUpperCase();
        
        try {
            const response = await fetch('/ntag/write', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ page: 4, data_hex: hexData })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showNtagResults(`Write Card Label "${cardLabel}"`, result);
                document.getElementById('cardLabelWrite').value = '';
            } else {
                alert(`Error: ${result.error}`);
            }
        } catch (error) {
            alert(`Network error: ${error.message}`);
        }
    }

    async function readCardLabel() {
        try {
            const response = await fetch('/ntag/read?page=4');
            const result = await response.json();
            
            if (response.ok) {
                // Convert hex back to string
                const hexData = result.data_hex;
                const bytes = [];
                for (let i = 0; i < hexData.length; i += 2) {
                    bytes.push(parseInt(hexData.substr(i, 2), 16));
                }
                const label = new TextDecoder().decode(new Uint8Array(bytes)).replace(/\0/g, '');
                
                showNtagResults(`Read Card Label: "${label}"`, result);
                if (label) {
                    document.getElementById('cardLabelWrite').value = label;
                }
            } else {
                alert(`Error: ${result.error}`);
            }
        } catch (error) {
            alert(`Network error: ${error.message}`);
        }
    }

    // Initialize
    createDeckSelector();
    updateCardUsage();
    checkPN532Status();
    
    // Auto-capture and status updates
    setInterval(checkForNewUID, 1000); // Check for new UIDs every second
    setInterval(updateCardUsage, 3000); // Update card usage every 3 seconds
    setInterval(checkPN532Status, 3000); // Check PN532 status and card data every 3 seconds
</script>
{% endblock %}
